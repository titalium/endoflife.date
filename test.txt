<?php

// ... [Le code pour la requête cURL reste inchangé] ...

// Décodage de la réponse JSON
$data = json_decode($response, true);

if (json_last_error() !== JSON_ERROR_NONE) {
    echo "Erreur lors du décodage JSON : " . json_last_error_msg();
    exit;
}

// Vérification de la structure de données
if (!isset($data['results']) || !is_array($data['results'])) {
    echo "Structure de données invalide";
    exit;
}

// Traitement des données
$summary = [];
foreach ($data['results'] as $item) {
    if (!isset($item['attrs']) || !is_array($item['attrs'])) {
        continue;
    }
    
    $attrs = $item['attrs'];
    $name = $attrs['name'] ?? 'Inconnu';
    $state = $attrs['state'] ?? null;

    if (!isset($summary[$name])) {
        $summary[$name] = ['count' => 0, 'states' => []];
    }
    $summary[$name]['count']++;
    $summary[$name]['states'][] = $state;
}

// Affichage du tableau HTML
echo "<table border='1'>
    <tr>
        <th>Nom</th>
        <th>Nombre d'occurrences</th>
        <th>États</th>
    </tr>";

foreach ($summary as $name => $info) {
    echo "<tr>
        <td>{$name}</td>
        <td>{$info['count']}</td>
        <td>";
    foreach ($info['states'] as $state) {
        $color = ($state === 0) ? 'green' : 'red';
        echo "<span style='color: {$color}; font-size: 20px;'>●</span> ";
    }
    echo "</td>
    </tr>";
}

echo "</table>";
